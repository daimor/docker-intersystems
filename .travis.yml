sudo: required
language: minimal
services:
- docker
env:
  matrix:
  - UNICODE=Y DOCKER_TAG=2018.1 ISC_PRODUCT=ensemble DOCKER_IMAGE=daimor/intersystems-$ISC_PRODUCT:$DOCKER_TAG
  - UNICODE=Y DOCKER_TAG=2018.1 ISC_PRODUCT=cache DOCKER_IMAGE=daimor/intersystems-$ISC_PRODUCT:$DOCKER_TAG
  - UNICODE=N DOCKER_TAG=8bit-2018.1 ISC_PRODUCT=cache DOCKER_IMAGE=daimor/intersystems-$ISC_PRODUCT:$DOCKER_TAG
  global:
  - ISC_BUILD=2018.1.2.309.5
branches:
  except:
  - master
install:
- "./download.sh"
- |
  docker run -d --name ftpd_server --rm \
    -e FTP_USER_NAME=user \
    -e FTP_USER_PASS=user \
    -e FTP_USER_HOME=/opt/ftp \
    -v `pwd`/ftp:/opt/ftp \
    --network host \
    stilliard/pure-ftpd
script:
- |
  docker build \
    --network host \
    --build-arg product=$ISC_PRODUCT \
    --build-arg version=$ISC_BUILD \
    --build-arg unicode=$UNICODE \
    -t $DOCKER_IMAGE \
    .
after_success:
- docker stop ftpd_server
- docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"
- docker push $DOCKER_IMAGE
